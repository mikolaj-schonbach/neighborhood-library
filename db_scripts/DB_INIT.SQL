-- ============================================================
-- Schema: library (MVP) - PostgreSQL
-- ============================================================

BEGIN;

-- Extensions
CREATE EXTENSION IF NOT EXISTS citext;

-- ============================================================
-- 1) users
-- ============================================================
CREATE TABLE IF NOT EXISTS users (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  first_name    TEXT NOT NULL,
  last_name     TEXT NOT NULL,
  login         CITEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  phone         TEXT NOT NULL,
  address       TEXT NOT NULL,
  status        TEXT NOT NULL DEFAULT 'INACTIVE', -- INACTIVE/ACTIVE/BANNED
  account_role  TEXT NOT NULL DEFAULT 'USER',     -- USER/ADMIN
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NULL
);

-- ============================================================
-- 2) categories
-- ============================================================
CREATE TABLE IF NOT EXISTS categories (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name       CITEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- 3) publications
-- ============================================================
CREATE TABLE IF NOT EXISTS publications (
  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  kind        TEXT NOT NULL, -- BOOK/MAGAZINE
  title       TEXT NOT NULL,
  isbn        TEXT NULL,
  year        SMALLINT NULL,
  category_id BIGINT NOT NULL,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NULL,

  CONSTRAINT publications_category_fk
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT,

  CONSTRAINT publications_year_chk
    CHECK (year IS NULL OR (year BETWEEN 1400 AND 2100))
);

-- ============================================================
-- 4) authors
-- ============================================================
CREATE TABLE IF NOT EXISTS authors (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  first_name CITEXT NOT NULL,
  last_name  CITEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- 5) publications_authors (N:M)
-- ============================================================
CREATE TABLE IF NOT EXISTS publications_authors (
  publication_id BIGINT NOT NULL,
  author_id      BIGINT NOT NULL,

  CONSTRAINT publications_authors_pk PRIMARY KEY (publication_id, author_id),

  CONSTRAINT publications_authors_publication_fk
    FOREIGN KEY (publication_id) REFERENCES publications(id) ON DELETE CASCADE,

  CONSTRAINT publications_authors_author_fk
    FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE RESTRICT
);

-- ============================================================
-- 6) copies
-- ============================================================
CREATE TABLE IF NOT EXISTS copies (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  publication_id BIGINT NOT NULL,
  inventory_code TEXT NOT NULL UNIQUE, -- LIB-YYYY-NNNNNN
  status         TEXT NOT NULL DEFAULT 'AVAILABLE', -- AVAILABLE/RESERVED/LOANED/UNAVAILABLE
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NULL,
  deleted_at     TIMESTAMPTZ NULL,

  CONSTRAINT copies_publication_fk
    FOREIGN KEY (publication_id) REFERENCES publications(id) ON DELETE RESTRICT,
	
  CONSTRAINT copies_deleted_means_unavailable_chk
    CHECK (deleted_at IS NULL OR status = 'UNAVAILABLE')
);

-- ============================================================
-- 7) reservations
-- ============================================================
CREATE TABLE IF NOT EXISTS reservations (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id      BIGINT NOT NULL,
  copy_id      BIGINT NOT NULL,
  reserved_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  pickup_until TIMESTAMPTZ NOT NULL,
  status       TEXT NOT NULL DEFAULT 'ACTIVE', -- ACTIVE/CANCELLED_BY_USER/CANCELLED_BY_ADMIN/EXPIRED/FULFILLED
  cancelled_at TIMESTAMPTZ NULL,
  expired_at   TIMESTAMPTZ NULL,
  fulfilled_at TIMESTAMPTZ NULL,

  -- Technical uniqueness to support composite FK from loans
  CONSTRAINT reservations_id_copy_user_uniq UNIQUE (id, copy_id, user_id),

  CONSTRAINT reservations_user_fk
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,

  CONSTRAINT reservations_copy_fk
    FOREIGN KEY (copy_id) REFERENCES copies(id) ON DELETE RESTRICT,

  CONSTRAINT reservations_pickup_chk
    CHECK (reserved_at <= pickup_until),

  CONSTRAINT reservations_active_timestamps_chk
    CHECK (
      status <> 'ACTIVE'
      OR (cancelled_at IS NULL AND expired_at IS NULL AND fulfilled_at IS NULL)
    ),

  CONSTRAINT reservations_cancelled_ts_chk
    CHECK (
      status NOT IN ('CANCELLED_BY_USER','CANCELLED_BY_ADMIN')
      OR cancelled_at IS NOT NULL
    ),

  CONSTRAINT reservations_expired_ts_chk
    CHECK (
      status <> 'EXPIRED'
      OR expired_at IS NOT NULL
    ),

  CONSTRAINT reservations_fulfilled_ts_chk
    CHECK (
      status <> 'FULFILLED'
      OR fulfilled_at IS NOT NULL
    )
);

-- ============================================================
-- 8) loans
-- ============================================================
CREATE TABLE IF NOT EXISTS loans (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  reservation_id BIGINT NOT NULL,
  copy_id        BIGINT NOT NULL,
  user_id        BIGINT NOT NULL,
  loaned_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  due_date       DATE NOT NULL DEFAULT (CURRENT_DATE + 30),
  returned_at    TIMESTAMPTZ NULL,

  CONSTRAINT loans_copy_fk
    FOREIGN KEY (copy_id) REFERENCES copies(id) ON DELETE RESTRICT,

  CONSTRAINT loans_user_fk
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,

  -- Composite FK enforces that loan matches reservation's user + copy
  CONSTRAINT loans_reservation_copy_user_fk
    FOREIGN KEY (reservation_id, copy_id, user_id)
    REFERENCES reservations(id, copy_id, user_id)
    ON DELETE RESTRICT

  -- Optional: chronology check (recommended)
  -- , CONSTRAINT loans_returned_after_loaned_chk
  --   CHECK (returned_at IS NULL OR returned_at >= loaned_at)
);

-- ============================================================
-- 9) messages
-- ============================================================
CREATE TABLE IF NOT EXISTS messages (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id    BIGINT NOT NULL,
  type       TEXT NOT NULL,
  title      TEXT NOT NULL,
  body       TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  read_at    TIMESTAMPTZ NULL,
  hidden_at  TIMESTAMPTZ NULL,

  CONSTRAINT messages_user_fk
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

  CONSTRAINT messages_hide_only_if_read_chk
    CHECK (hidden_at IS NULL OR read_at IS NOT NULL)
);

-- ============================================================
-- 10) login_logs
-- ============================================================
CREATE TABLE IF NOT EXISTS login_logs (
  id        BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id   BIGINT NULL,
  login     CITEXT NULL,
  logged_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  success   BOOLEAN NOT NULL,

  CONSTRAINT login_logs_user_fk
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- ============================================================
-- 11) operations_history
-- ============================================================
CREATE TABLE IF NOT EXISTS operations_history (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  actor_user_id BIGINT NOT NULL,
  target_user_id BIGINT NULL,
  action        TEXT NOT NULL,
  copy_id       BIGINT NULL,
  happened_at   TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT operations_history_actor_fk
    FOREIGN KEY (actor_user_id) REFERENCES users(id) ON DELETE RESTRICT,

  CONSTRAINT operations_history_target_fk
    FOREIGN KEY (target_user_id) REFERENCES users(id) ON DELETE RESTRICT,

  CONSTRAINT operations_history_copy_fk
    FOREIGN KEY (copy_id) REFERENCES copies(id) ON DELETE SET NULL
);

-- ============================================================
-- 12) library_info
-- ============================================================
CREATE TABLE IF NOT EXISTS library_info (
  id            SMALLINT PRIMARY KEY DEFAULT 1,
  address       TEXT NOT NULL,
  opening_hours TEXT NOT NULL,
  rules         TEXT NOT NULL,
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT library_info_single_row_chk CHECK (id = 1)
);

-- ============================================================
-- Indexes (per db-plan.md)
-- ============================================================

-- 3.1 Uniqueness / operational consistency
CREATE UNIQUE INDEX IF NOT EXISTS publication_isbn_uniq_not_null
  ON publications(isbn)
  WHERE isbn IS NOT NULL;

-- inventory_code already UNIQUE constraint, but keeping explicit name is optional.
-- If you want the exact named index, you can drop the constraint and create this instead.
-- CREATE UNIQUE INDEX IF NOT EXISTS copy_inventory_code_uniq ON copies(inventory_code);

CREATE UNIQUE INDEX IF NOT EXISTS reservation_one_active_per_copy
  ON reservations(copy_id)
  WHERE status = 'ACTIVE';

CREATE UNIQUE INDEX IF NOT EXISTS loan_one_per_reservation
  ON loans(reservation_id);

CREATE UNIQUE INDEX IF NOT EXISTS loan_one_active_per_copy
  ON loans(copy_id)
  WHERE returned_at IS NULL;

-- 3.2 Catalog/search
CREATE INDEX IF NOT EXISTS publication_category_idx
  ON publications(category_id);

CREATE INDEX IF NOT EXISTS authors_name_idx
  ON authors(last_name, first_name);

-- 3.3 Join helpers
CREATE INDEX IF NOT EXISTS publication_authors_author_idx
  ON publications_authors(author_id);

CREATE INDEX IF NOT EXISTS copy_publication_idx
  ON copies(publication_id);

CREATE INDEX IF NOT EXISTS reservation_user_idx
  ON reservations(user_id, status);

CREATE INDEX IF NOT EXISTS loan_user_idx
  ON loans(user_id);

COMMIT;
