## 0. Założenia techniczne (PostgreSQL)

* **Wymagane rozszerzenia**: `citext` (dla unikalności bez wrażliwości na wielkość liter) 
* Timestamps: `timestamptz`, daty terminów zwrotu: `date`. 

---

## 1. Lista tabel (kolumny, typy, ograniczenia)

### 1.1 `users`

**Cel:** czytelnicy + administratorzy  

* `id` BIGINT PK, `GENERATED BY DEFAULT AS IDENTITY`
* `first_name` TEXT NOT NULL
* `last_name` TEXT NOT NULL
* `login` CITEXT NOT NULL **UNIQUE**
* `password_hash` TEXT NOT NULL
* `phone` TEXT NOT NULL
* `address` TEXT NOT NULL
* `status` TEXT NOT NULL DEFAULT `INACTIVE`  *(INACTIVE/ACTIVE/BANNED)*
* `account_role` TEXT NOT NULL DEFAULT `USER` *(USER/ADMIN)*
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `updated_at` TIMESTAMPTZ NULLABLE


---

### 1.2 `categories`

**Cel:** słownik kategorii, tylko niepuste usuwalne. 

* `id` BIGINT PK IDENTITY
* `name` CITEXT NOT NULL **UNIQUE**
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()

---

### 1.3 `publications`

**Cel:** dane bibliograficzne wspólne dla BOOK/MAGAZINE. 

* `id` BIGINT PK IDENTITY
* `kind` TEXT NOT NULL *(BOOK/MAGAZINE)*
* `title` TEXT NOT NULL
* `isbn` TEXT NULLABLE
* `year` SMALLINT NULLABLE
* `category_id` BIGINT NOT NULL FK → `categories(id)` **ON DELETE RESTRICT**
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `updated_at` TIMESTAMPTZ NULLABLE

**CHECK (opcjonalne, zgodne z MVP):**

* `year IS NULL OR (year BETWEEN 1400 AND 2100)`


---

### 1.4 `authors`

**Cel:** autorzy w 3NF. 

* `id` BIGINT PK IDENTITY
* `first_name` CITEXT NOT NULL
* `last_name` CITEXT NOT NULL
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()

---

### 1.5 `publications_authors` (tabela łącząca N:M)

* `publication_id` BIGINT NOT NULL FK → `publications(id)` **ON DELETE CASCADE**
* `author_id` BIGINT NOT NULL FK → `authors(id)` **ON DELETE RESTRICT**
* **PK (`publication_id`, `author_id`)**

---

### 1.6 `copies`

**Cel:** fizyczny egzemplarz (osobny rekord) + cache statusu dla UI. 

* `id` BIGINT PK IDENTITY
* `publication_id` BIGINT NOT NULL FK → `publications(id)` **ON DELETE RESTRICT**
* `inventory_code` TEXT NOT NULL **UNIQUE**  *(format `LIB-YYYY-NNNNNN`)*
* `status` TEXT NOT NULL DEFAULT `AVAILABLE` *(AVAILABLE/RESERVED/LOANED/UNAVAILABLE)*
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `updated_at` TIMESTAMPTZ NULLABLE
* `deleted_at` TIMESTAMPTZ NULLABLE

**Zasady DB:**

* Trigger/constraint blokujący ręczne ustawienie `status=UNAVAILABLE`, jeśli istnieje aktywna rezerwacja lub aktywne wypożyczenie dla tego egzemplarza.

---

### 1.7 `reservations`

**Cel:** rezerwacja zawsze wskazuje konkretny egzemplarz (`copy_id`). 

* `id` BIGINT PK IDENTITY
* `user_id` BIGINT NOT NULL FK → `users(id)` **ON DELETE RESTRICT**
* `copy_id` BIGINT NOT NULL FK → `copies(id)` **ON DELETE RESTRICT**
* `reserved_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `pickup_until` TIMESTAMPTZ NOT NULL
* `status` TEXT NOT NULL DEFAULT `ACTIVE` *(ACTIVE/CANCELLED_BY_USER/CANCELLED_BY_ADMIN/EXPIRED/FULFILLED)*
* `cancelled_at` TIMESTAMPTZ NULLABLE
* `expired_at` TIMESTAMPTZ NULLABLE
* `fulfilled_at` TIMESTAMPTZ NULLABLE

* UNIQUE (id, copy_id, user_id)

**CHECK (spójność timestampów vs status):**

-- 1) reserved_at <= pickup_until
CHECK (reserved_at <= pickup_until),

-- 2) status='ACTIVE' -> cancelled_at IS NULL AND expired_at IS NULL AND fulfilled_at IS NULL
CHECK (
  status <> 'ACTIVE'
  OR (cancelled_at IS NULL AND expired_at IS NULL AND fulfilled_at IS NULL)
),

-- 3) status IN (...) -> cancelled_at IS NOT NULL
CHECK (
  status NOT IN ('CANCELLED_BY_USER','CANCELLED_BY_ADMIN')
  OR cancelled_at IS NOT NULL
),

-- 4) status='EXPIRED' -> expired_at IS NOT NULL
CHECK (
  status <> 'EXPIRED'
  OR expired_at IS NOT NULL
),

-- 5) status='FULFILLED' -> fulfilled_at IS NOT NULL
CHECK (
  status <> 'FULFILLED'
  OR fulfilled_at IS NOT NULL
)



---

### 1.8 `loans`

**Cel:** wypożyczenie, zawsze oparte o rezerwację; termin zwrotu = 30 dni. 

* `id` BIGINT PK IDENTITY
* `reservation_id` BIGINT NOT NULL
* `copy_id` BIGINT NOT NULL FK → `copies(id)` **ON DELETE RESTRICT**
* `user_id` BIGINT NOT NULL FK → `users(id)` **ON DELETE RESTRICT**
* `loaned_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `due_date` DATE NOT NULL DEFAULT (CURRENT_DATE + 30)
* `returned_at` TIMESTAMPTZ NULLABLE

**FK (spójność user/copy z rezerwacją):**

* FK (`reservation_id`, `copy_id`, `user_id`) → `reservations(id, copy_id, user_id)` **ON DELETE RESTRICT**


**Zasady DB:**

* Trigger na INSERT do `loans`: wymusza, że wskazana `reservation` ma status `ACTIVE`, atomowo ustawia ją na `FULFILLED` + `fulfilled_at`, oraz aktualizuje `copy.status`. 

---

### 1.9 `messages`

**Cel:** wiadomości systemowe (read/unread) + soft-hide tylko po przeczytaniu. 

* `id` BIGINT PK IDENTITY
* `user_id` BIGINT NOT NULL FK → `users(id)` **ON DELETE CASCADE**
* `type` TEXT NOT NULL *(np. DUE_SOON/OVERDUE/ACCOUNT_BANNED/LOAN_CREATED)*
* `title` TEXT NOT NULL
* `body` TEXT NOT NULL
* `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `read_at` TIMESTAMPTZ NULLABLE
* `hidden_at` TIMESTAMPTZ NULLABLE

**CHECK:**

* `hidden_at IS NULL OR read_at IS NOT NULL` *(ukrywanie tylko gdy przeczytana)*

---

### 1.10 `login_logs`

**Cel:** metryki logowań (retencja), sukces/porażka. 

* `id` BIGINT PK IDENTITY
* `user_id` BIGINT NULL FK → `users(id)` **ON DELETE SET NULL** *(dla prób logowania nieistniejącym loginem)*
* `login` CITEXT NULL  *(snapshot wpisanego loginu, opcjonalnie)*
* `logged_at` TIMESTAMPTZ NOT NULL DEFAULT now()
* `success` BOOLEAN NOT NULL

---

### 1.11 `operations_history`

**Cel:** audyt i metryki operacji (np. wypożyczenie w kwartale). 

* `id` BIGINT PK IDENTITY
* `actor_user_id` BIGINT NOT NULL FK → `users(id)` **ON DELETE RESTRICT**
* `target_user_id` BIGINT NULL FK → `users(id)` **ON DELETE RESTRICT**
* `action` TEXT  NOT NULL *(RESERVATION_CREATED, RESERVATION_CANCELLED, RESERVATION_EXPIRED, LOAN_CREATED, LOAN_RETURNED, USER_BANNED, USER_UNBANNED, USER_ACTIVATED, USER_PROFILE_UPDATED, COPY_CREATED)*
* `copy_id` BIGINT NULL FK → `copies(id)` **ON DELETE SET NULL**
* `happened_at` TIMESTAMPTZ NOT NULL DEFAULT now()


---

### 1.12 `library_info`

**Cel:** publiczna (anon) informacja „O bibliotece”. 

* `id` SMALLINT PK DEFAULT 1 CHECK (`id = 1`)
* `address` TEXT NOT NULL
* `opening_hours` TEXT NOT NULL
* `rules` TEXT NOT NULL
* `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()

---

## 2. Relacje między tabelami (kardynalność)

* `categories (1) — (N) publications` przez `publications.category_id` (RESTRICT delete kategorii niepustej).
* `publications (1) — (N) copies` przez `copies.publication_id` (RESTRICT delete publikacji z egzemplarzami).
* `publications (N) — (M) authors` przez `publications_authors`.
* `users (1) — (N) reservations` przez `reservations.user_id`.
* `copies (1) — (N) reservations` przez `reservations.copy_id` (RESTRICT). 
* `reservations (1) — (0..1) loans` logicznie; technicznie `loans` ma FK do `reservations(id,copy_id,user_id)` i `UNIQUE(reservation_id)` (patrz indeksy).
* `users (1) — (N) loans` przez `loans.user_id`.
* `users (1) — (N) messages` przez `messages.user_id`.
* `users (1) — (N) login_logs`, `users (1) — (N) operations_history (actor/target)`.

---

## 3. Indeksy (wydajność + spójność współbieżności)

### 3.1 Unikalności / spójność operacyjna

* `publication_isbn_uniq_not_null`: **UNIQUE** (`isbn`) **WHERE** `isbn IS NOT NULL`
* `copy_inventory_code_uniq`: **UNIQUE** (`inventory_code`)
* `reservation_one_active_per_copy`: **UNIQUE** (`copy_id`) **WHERE** `status = 'ACTIVE'`
* `loan_one_per_reservation`: **UNIQUE** (`reservation_id`)
* `loan_one_active_per_copy`: **UNIQUE** (`copy_id`) **WHERE** `returned_at IS NULL` 


### 3.2 Wyszukiwarka / katalog

* `publication_category_idx`: (`category_id`)
* `authors_name_idx`: (`last_name`, `first_name`) *(pomocniczo)*


### 3.3 Łączenia N:M

* `publication_authors_author_idx`: (`author_id`)
* `copy_publication_idx`: (`publication_id`)
* `reservation_user_idx`: (`user_id`, `status`)
* `loan_user_idx`: (`user_id`)

---


## 4. Dodatkowe uwagi / decyzje projektowe (ważne do migracji)

* **Limit 3 sztuk (rezerwacje + wypożyczenia)**: egzekwowany triggerem (na `reservations` przy tworzeniu/aktywacji oraz na `loans` przy tworzeniu/aktywacji), niezależnie od walidacji w aplikacji. 
* **Współbieżność rezerwacji**: rezerwacja tworzona transakcyjnie dla `publication_id` przez wybór egzemplarza: `SELECT ... FOR UPDATE SKIP LOCKED` z warunkiem `copies.status='AVAILABLE'`, następnie INSERT do `reservations(copy_id, user_id)` a zmiana copies.status następuje przez triggery na reservations/loans w tej samej transakcji.
* **`copies.status` jako cache dla UI**: utrzymywany triggerami na `reservations/loans`; ręczny `UNAVAILABLE` dozwolony tylko gdy brak aktywnych rezerwacji/wypożyczeń. 
* **Hard-delete**: usuwanie `copies` blokowane, gdy status `RESERVED/LOANED` lub istnieje aktywna rezerwacja/wypożyczenie (trigger). `publications` tylko gdy brak `copies` (FK RESTRICT). Kategorie tylko gdy brak publikacji (RESTRICT). 
 
